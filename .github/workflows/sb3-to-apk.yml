name: SB3 è½¬ APK è‡ªåŠ¨æ„å»º
on:
  workflow_dispatch:
    inputs:
      package_name:
        description: 'APK åŒ…åï¼ˆç¬¦åˆ Android è§„èŒƒï¼Œä¾‹å¦‚ï¼šcom.example.myappï¼‰'
        required: true
        type: string
      app_name:
        description: 'åº”ç”¨æ˜¾ç¤ºåç§°ï¼ˆä¾‹å¦‚ï¼šæˆ‘çš„Scratchåº”ç”¨ï¼‰'
        required: true
        type: string
      sb3_filename:
        description: 'project æ–‡ä»¶å¤¹ä¸‹çš„ .sb3 æ–‡ä»¶åï¼ˆä¾‹å¦‚ï¼šdemo.sb3ï¼‰'
        required: true
        type: string

jobs:
  build-apk:
    runs-on: ubuntu-latest
    env:
      TURBOWARP_DIR: Turbowarp-packager
      PROJECT_DIR: ${{ github.workspace }}/project
      OUTPUT_HTML_DIR: ${{ github.workspace }}/output-html
      CORDOVA_DIR: ${{ github.workspace }}/cordova-project

    steps:
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: éªŒè¯ SB3 æ–‡ä»¶
        run: |
          SB3_PATH="${PROJECT_DIR}/${{ inputs.sb3_filename }}"
          if [ ! -f "$SB3_PATH" ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° SB3 æ–‡ä»¶ - $SB3_PATH"
            ls -la "$PROJECT_DIR"
            exit 1
          fi
          echo "âœ… æ‰¾åˆ° SB3 æ–‡ä»¶ï¼š$SB3_PATH"

      - name: å…‹éš† TurboWarp Packager
        run: |
          if [ ! -d "${TURBOWARP_DIR}" ]; then
            git clone https://github.com/TurboWarp/packager.git "${TURBOWARP_DIR}"
          fi
          ls -la "${TURBOWARP_DIR}"

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: ${{ env.TURBOWARP_DIR }}/package-lock.json

      - name: æ„å»º Turbowarp æ¨¡å—ï¼ˆä¿®å¤ï¼šé€‚é…å®˜æ–¹æ„å»ºå‘½ä»¤ï¼‰
        run: |
          cd "${TURBOWARP_DIR}"
          npm ci
          npm run build-prod  # å…³é”®ä¿®å¤ï¼šå®˜æ–¹æœ€æ–°ç‰ˆç”¨ build-prod æ›¿ä»£ build-node-prod
          # éªŒè¯æ„å»ºäº§ç‰©è·¯å¾„
          ls -la dist/ && ls -la dist/packager/

      - name: ç”Ÿæˆè½¬æ¢è„šæœ¬ï¼ˆä¿®å¤ï¼šä¿®æ­£æ¨¡å—å¼•å…¥è·¯å¾„ï¼‰
        run: |
          cat > "${TURBOWARP_DIR}/convert-sb3.js" << 'EOF'
          const fs = require('fs');
          const path = require('path');
          // å…³é”®ä¿®å¤ï¼šä¿®æ­£ Node.js æ¨¡å—å¼•å…¥è·¯å¾„ï¼ˆå®˜æ–¹äº§ç‰©åœ¨ dist/packagerï¼‰
          const Packager = require('./dist/packager');

          // ç¯å¢ƒå˜é‡ä¼ å…¥çš„å‚æ•°
          const sb3Path = process.env.SB3_PATH;
          const outputHtmlPath = process.env.OUTPUT_HTML_PATH;

          // æ ¸å¿ƒè½¬æ¢é€»è¾‘
          const run = async () => {
            // åˆ›å»ºè¾“å‡ºç›®å½•
            fs.mkdirSync(path.dirname(outputHtmlPath), { recursive: true });
            
            // è¯»å– SB3 æ–‡ä»¶
            console.log(`ğŸ“¥ è¯»å– SB3 æ–‡ä»¶: ${sb3Path}`);
            const projectData = fs.readFileSync(sb3Path);

            // åŠ è½½ Scratch é¡¹ç›®ï¼ˆé€‚é…å®˜æ–¹ APIï¼‰
            console.log('ğŸ”§ åŠ è½½é¡¹ç›®...');
            const loadedProject = await Packager.loadProject(projectData);

            // åˆå§‹åŒ– Turbowarp æ‰“åŒ…å™¨
            const packager = new Packager.Packager();
            packager.project = loadedProject;
            packager.options.target = 'html'; // æŒ‡å®šè¾“å‡ºä¸º HTML
            packager.options.turbo = true;    // å¯ç”¨ Turbo æ¨¡å¼ä¼˜åŒ–

            // æ‰§è¡Œæ‰“åŒ…
            console.log('âš™ï¸ è½¬æ¢ SB3 åˆ° HTML...');
            const result = await packager.package();

            // å¤„ç†è¾“å‡ºæ•°æ®ï¼ˆå…¼å®¹ ArrayBuffer/å­—ç¬¦ä¸²ï¼‰
            let htmlData = result.data;
            if (htmlData instanceof ArrayBuffer) {
              htmlData = Buffer.from(htmlData).toString('utf8');
            }

            // å†™å…¥ HTML æ–‡ä»¶
            fs.writeFileSync(outputHtmlPath, htmlData);
            console.log(`âœ… HTML ç”Ÿæˆå®Œæˆ: ${outputHtmlPath}`);
          };

          // æ‰§è¡Œå¹¶æ•è·é”™è¯¯
          run().catch((err) => {
            console.error('âŒ è½¬æ¢å¤±è´¥:', err);
            process.exit(1);
          });
          EOF
        env:
          SB3_PATH: ${{ env.PROJECT_DIR }}/${{ inputs.sb3_filename }}
          OUTPUT_HTML_PATH: ${{ env.OUTPUT_HTML_DIR }}/index.html

      - name: è½¬æ¢ SB3 åˆ° HTML
        run: |
          cd "${TURBOWARP_DIR}"
          node convert-sb3.js

      - name: å®‰è£… Android & Cordova ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            openjdk-17-jdk \
            android-sdk \
            gradle \
            unzip \
            wget

          npm install -g cordova@12.0.0

          echo "ANDROID_HOME=/usr/lib/android-sdk" >> $GITHUB_ENV
          echo "PATH=\$PATH:/usr/lib/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_ENV

          yes | sdkmanager --licenses || true
          sdkmanager "platforms;android-34" "build-tools;34.0.0" "platform-tools"

      - name: ç”¨ Cordova æ‰“åŒ… HTML ä¸º APK
        run: |
          mkdir -p "${CORDOVA_DIR}"
          cd "${CORDOVA_DIR}"

          cordova create app ${{ inputs.package_name }} "${{ inputs.app_name }}"
          cd app

          cordova platform add android@12.0.0

          rm -rf www/*
          cp -r "${OUTPUT_HTML_DIR}"/* www/

          cordova build android --debug

          APK_PATH=$(find platforms/android/app/build/outputs/apk/debug -name "*.apk" | head -1)
          cp "$APK_PATH" "${CORDOVA_DIR}/${{ inputs.app_name }}_debug.apk"
          echo "âœ… APK ç”Ÿæˆå®Œæˆ: ${CORDOVA_DIR}/${{ inputs.app_name }}_debug.apk"

      - name: ä¸Šä¼  APK äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.app_name }}-apk-${{ github.run_id }}
          path: ${{ env.CORDOVA_DIR }}/${{ inputs.app_name }}_debug.apk
          retention-days: 30
