name: SB3 è½¬ APK è‡ªåŠ¨æ„å»º
on:
  workflow_dispatch:
    inputs:
      package_name:
        description: 'APK åŒ…åï¼ˆç¬¦åˆ Android è§„èŒƒï¼Œä¾‹å¦‚ï¼šcom.example.myappï¼‰'
        required: true
        type: string
      app_name:
        description: 'åº”ç”¨æ˜¾ç¤ºåç§°ï¼ˆä¾‹å¦‚ï¼šæˆ‘çš„Scratchåº”ç”¨ï¼‰'
        required: true
        type: string
      sb3_filename:
        description: 'project æ–‡ä»¶å¤¹ä¸‹çš„ .sb3 æ–‡ä»¶åï¼ˆä¾‹å¦‚ï¼šdemo.sb3ï¼‰'
        required: true
        type: string

jobs:
  build-apk:
    runs-on: ubuntu-latest
    env:
      # å…¨å±€ç¯å¢ƒå˜é‡ï¼Œç»Ÿä¸€è·¯å¾„å’Œç‰ˆæœ¬
      TURBOWARP_DIR: Turbowarp-packager
      PROJECT_DIR: ${{ github.workspace }}/project
      OUTPUT_HTML_DIR: ${{ github.workspace }}/output-html
      CORDOVA_DIR: ${{ github.workspace }}/cordova-project

    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºå½“å‰ä»“åº“ä»£ç ï¼ˆåŒ…å« project æ–‡ä»¶å¤¹ï¼‰
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # æ­¥éª¤2ï¼šæ£€æŸ¥ SB3 æ–‡ä»¶æ˜¯å¦å­˜åœ¨
      - name: éªŒè¯ SB3 æ–‡ä»¶
        run: |
          SB3_PATH="${PROJECT_DIR}/${{ inputs.sb3_filename }}"
          if [ ! -f "$SB3_PATH" ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° SB3 æ–‡ä»¶ - $SB3_PATH"
            ls -la "$PROJECT_DIR"
            exit 1
          fi
          echo "âœ… æ‰¾åˆ° SB3 æ–‡ä»¶ï¼š$SB3_PATH"

      # æ­¥éª¤3ï¼šå…‹éš† TurboWarp Packager ä»“åº“ï¼ˆè‹¥æœªåŒ…å«åœ¨å½“å‰ä»“åº“ï¼‰
      - name: å…‹éš† TurboWarp Packager
        run: |
          if [ ! -d "${TURBOWARP_DIR}" ]; then
            git clone https://github.com/TurboWarp/packager.git "${TURBOWARP_DIR}"
          fi
          ls -la "${TURBOWARP_DIR}"

      # æ­¥éª¤4ï¼šé…ç½® Node.js ç¯å¢ƒï¼ˆTurbowarp ä¾èµ– Node.jsï¼‰
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: ${{ env.TURBOWARP_DIR }}/package-lock.json

      # æ­¥éª¤5ï¼šå®‰è£… Turbowarp ä¾èµ–å¹¶æ„å»º Node API
      - name: æ„å»º Turbowarp Node æ¨¡å—
        run: |
          cd "${TURBOWARP_DIR}"
          npm ci  # å®‰è£…ä¾èµ–ï¼ˆä¸¥æ ¼åŒ¹é… lock æ–‡ä»¶ï¼‰
          npm run build-node-prod  # æ„å»º Node.js ç‰ˆæœ¬çš„ API

      # æ­¥éª¤6ï¼šç¼–å†™ SB3 è½¬ HTML çš„è„šæœ¬
      - name: ç”Ÿæˆè½¬æ¢è„šæœ¬
        run: |
          cat > "${TURBOWARP_DIR}/convert-sb3.js" << 'EOF'
          const fs = require('fs');
          const path = require('path');
          const Packager = require('./dist-node/index.js');

          // ç¯å¢ƒå˜é‡ä¼ å…¥çš„å‚æ•°
          const sb3Path = process.env.SB3_PATH;
          const outputHtmlPath = process.env.OUTPUT_HTML_PATH;

          // æ ¸å¿ƒè½¬æ¢é€»è¾‘
          const run = async () => {
            // åˆ›å»ºè¾“å‡ºç›®å½•
            fs.mkdirSync(path.dirname(outputHtmlPath), { recursive: true });
            
            // è¯»å– SB3 æ–‡ä»¶
            console.log(`ğŸ“¥ è¯»å– SB3 æ–‡ä»¶: ${sb3Path}`);
            const projectData = fs.readFileSync(sb3Path);

            // åŠ è½½ Scratch é¡¹ç›®
            console.log('ğŸ”§ åŠ è½½é¡¹ç›®...');
            const loadedProject = await Packager.loadProject(projectData);

            // åˆå§‹åŒ– Turbowarp æ‰“åŒ…å™¨
            const packager = new Packager.Packager();
            packager.project = loadedProject;
            packager.options.target = 'html'; // æŒ‡å®šè¾“å‡ºä¸º HTML
            packager.options.turbo = true;    // å¯ç”¨ Turbo æ¨¡å¼ä¼˜åŒ–

            // æ‰§è¡Œæ‰“åŒ…
            console.log('âš™ï¸ è½¬æ¢ SB3 åˆ° HTML...');
            const result = await packager.package();

            // å†™å…¥ HTML æ–‡ä»¶
            fs.writeFileSync(outputHtmlPath, result.data);
            console.log(`âœ… HTML ç”Ÿæˆå®Œæˆ: ${outputHtmlPath}`);
          };

          // æ‰§è¡Œå¹¶æ•è·é”™è¯¯
          run().catch((err) => {
            console.error('âŒ è½¬æ¢å¤±è´¥:', err);
            process.exit(1);
          });
          EOF
        env:
          SB3_PATH: ${{ env.PROJECT_DIR }}/${{ inputs.sb3_filename }}
          OUTPUT_HTML_PATH: ${{ env.OUTPUT_HTML_DIR }}/index.html

      # æ­¥éª¤7ï¼šæ‰§è¡Œ SB3 è½¬ HTML è„šæœ¬
      - name: è½¬æ¢ SB3 åˆ° HTML
        run: |
          cd "${TURBOWARP_DIR}"
          node convert-sb3.js

      # æ­¥éª¤8ï¼šå®‰è£… Android æ„å»ºç¯å¢ƒå’Œ Cordovaï¼ˆHTML è½¬ APK å·¥å…·ï¼‰
      - name: å®‰è£… Android & Cordova ä¾èµ–
        run: |
          # å®‰è£…ç³»ç»Ÿä¾èµ–
          sudo apt-get update
          sudo apt-get install -y \
            openjdk-17-jdk \
            android-sdk \
            gradle \
            unzip \
            wget

          # å®‰è£… Cordova
          npm install -g cordova@12.0.0

          # é…ç½® Android SDK ç¯å¢ƒå˜é‡
          echo "ANDROID_HOME=/usr/lib/android-sdk" >> $GITHUB_ENV
          echo "PATH=\$PATH:/usr/lib/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_ENV

          # è‡ªåŠ¨æ¥å— Android SDK è®¸å¯
          yes | sdkmanager --licenses || true

          # å®‰è£…å¿…è¦çš„ Android ç»„ä»¶ï¼ˆAPI 34 å…¼å®¹å¤§éƒ¨åˆ†è®¾å¤‡ï¼‰
          sdkmanager "platforms;android-34" "build-tools;34.0.0" "platform-tools"

      # æ­¥éª¤9ï¼šåˆ›å»º Cordova é¡¹ç›®å¹¶æ‰“åŒ… APK
      - name: ç”¨ Cordova æ‰“åŒ… HTML ä¸º APK
        run: |
          # åˆ›å»º Cordova é¡¹ç›®ç›®å½•
          mkdir -p "${CORDOVA_DIR}"
          cd "${CORDOVA_DIR}"

          # åˆå§‹åŒ– Cordova é¡¹ç›®ï¼ˆæŒ‡å®šåŒ…åå’Œåº”ç”¨åï¼‰
          cordova create app ${{ inputs.package_name }} "${{ inputs.app_name }}"
          cd app

          # æ·»åŠ  Android å¹³å°
          cordova platform add android@12.0.0

          # æ›¿æ¢ Cordova é»˜è®¤é¡µé¢ä¸ºç”Ÿæˆçš„ HTML
          rm -rf www/*
          cp -r "${OUTPUT_HTML_DIR}"/* www/

          # æ„å»º APKï¼ˆDebug ç‰ˆæœ¬ï¼Œæ— éœ€ç­¾åï¼‰
          cordova build android --debug

          # æŸ¥æ‰¾ç”Ÿæˆçš„ APK å¹¶å¤åˆ¶åˆ°æ˜“è®¿é—®è·¯å¾„
          APK_PATH=$(find platforms/android/app/build/outputs/apk/debug -name "*.apk" | head -1)
          cp "$APK_PATH" "${CORDOVA_DIR}/${{ inputs.app_name }}_debug.apk"
          echo "âœ… APK ç”Ÿæˆå®Œæˆ: ${CORDOVA_DIR}/${{ inputs.app_name }}_debug.apk"

      # æ­¥éª¤10ï¼šä¸Šä¼  APK ä½œä¸ºæ„å»ºäº§ç‰©ï¼ˆä¾›ä¸‹è½½ï¼‰
      - name: ä¸Šä¼  APK äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.app_name }}-apk-${{ github.run_id }}
          path: ${{ env.CORDOVA_DIR }}/${{ inputs.app_name }}_debug.apk
          retention-days: 30  # äº§ç‰©ä¿ç•™ 30 å¤©
